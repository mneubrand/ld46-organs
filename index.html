<!DOCTYPE html>
<html>
<head>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.22.0/dist/phaser.js"></script>
    <style>
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script>
    var WIDTH = 1200;
    var HEIGHT = 750;
    var TIME_BETWEEN_ORGANS = 15000;
    var START_ALPHA = 0.3;

    var config = {
        type: Phaser.AUTO,
        width: 1200,
        height: 750,
        scene: {
            preload: preload,
            create: create
        }
    };

    var game = new Phaser.Game(config);

    function preload () {
        this.load.image('body', 'assets/body.png');
        this.load.image('heart', 'assets/heart.png');
        this.load.image('heart_veins', 'assets/heart_veins.png');
        this.load.image('trachea', 'assets/trachea.png');
        this.load.image('left_lung', 'assets/left_lung.png');
        this.load.image('right_lung', 'assets/right_lung.png');
        this.load.image('key_space', 'assets/key_space.png');
        this.load.image('pow', 'assets/pow.png');
        this.load.image('arrow_up', 'assets/arrow_up.png');
        this.load.image('arrow_down', 'assets/arrow_down.png');
        this.load.image('pointer', 'assets/pointer.png');
        this.load.image('liver', 'assets/liver.png');
        this.load.image('checkmark', 'assets/checkmark.png');
        this.load.image('type', 'assets/type.png');
        this.load.image('kidney_left', 'assets/kidney_left.png');
        this.load.image('kidney_right', 'assets/kidney_right.png');
        this.load.image('game_over', 'assets/game_over.png');
    }

    var scene;
    var heart, heartVeins, keySpace;
    var lung, trachea, lungArrow, lungPointer;
    var liver;
    var kidneys, leftKidney, rightKidney;
    var gameOver;
    var score, scoreTimer;

    function create () {
        scene = this;

        this.cameras.main.backgroundColor.setTo(255,255,255);
        var body = this.add.image(WIDTH/2, HEIGHT/2, 'body');

        // Liver
        liver = this.add.container(WIDTH/2 - 40, 440);
        liver.angle = 1;
        liver.add(this.add.image(0, 0, 'liver'));
        liver.alpha = START_ALPHA;

        // Kidney
        kidneys = this.add.container(WIDTH/2, 500);
        kidneys.alpha = START_ALPHA;
        leftKidney = this.add.image(-60, 0, 'kidney_left');
        rightKidney = this.add.image(60, 0, 'kidney_right');
        kidneys.add(leftKidney);
        kidneys.add(rightKidney);
        leftKidney.pointer = this.add.image(-60, 80, 'pointer');
        this.tweens.add({
            targets: leftKidney.pointer,
            scale: 1.1,
            y: 70,
            duration: 500,
            repeat: 10000,
            ease: 'Power2',
            yoyo: true
        });
        leftKidney.pointer.visible = false;
        rightKidney.pointer = this.add.image(60, 80, 'pointer');
        this.tweens.add({
            targets: rightKidney.pointer,
            scale: 1.1,
            y: 70,
            duration: 500,
            repeat: 10000,
            ease: 'Power2',
            yoyo: true
        });
        rightKidney.pointer.visible = false;
        kidneys.add(leftKidney.pointer);
        kidneys.add(rightKidney.pointer);

        // Lung
        trachea = this.add.image(WIDTH/2, 100, 'trachea');
        trachea.alpha = START_ALPHA;
        lung = this.add.container(WIDTH/2, 100);
        lung.add(this.add.image(-115, 120, 'left_lung'));
        lung.add(this.add.image( 115, 120, 'right_lung'));
        lung.alpha = START_ALPHA;
        lung.scale = 0.85;
        lungArrow = this.add.sprite(WIDTH/2, 100, 'arrow_down');
        lungArrow.visible = false;
        lungPointer = this.add.image(WIDTH/2 + 5, 140, 'pointer');
        this.tweens.add({
            targets: lungPointer,
            scale: 1.1,
            y: 130,
            duration: 500,
            repeat: 1000,
            ease: 'Power2',
            yoyo: true
        });
        lungPointer.visible = false;

        // Heart
        heart = this.add.container(WIDTH/2 + 50, 270);
        heart.add(this.add.image(0, 0, 'heart'));
        heart.in = true;
        heartVeins = this.add.image(5, 35, 'heart_veins');
        heartVeins.scale = 1.1;
        heartVeins.alpha = 0.3;
        heart.add(heartVeins);
        keySpace = this.add.image(WIDTH/2 + 50, 360, 'key_space');
        this.tweens.add({
            targets: keySpace,
            scale: 1.1,
            y: 350,
            duration: 500,
            repeat: 10000,
            ease: 'Power2',
            yoyo: true
        });


        this.input.keyboard.on('keydown', function (event) {
            if (event.keyCode === Phaser.Input.Keyboard.KeyCodes.SPACE) {
                event.preventDefault();
                handleHeart();
            } else {
                if(liver.alpha == 1.0) {
                    var letter = String.fromCharCode(event.keyCode);
                    if(letter >= 'A' && letter <= 'Z') {
                        handleLiverInput(letter);
                    }
                }

            }
        });

        gameOver = this.add.image(WIDTH/2, HEIGHT/2, 'game_over');
        gameOver.setDepth(1);
        gameOver.visible = false;
    }

    function handleHeart() {
        if(keySpace.visible) {
            // Start heart timer
            keySpace.visible = false;

            heart.duration = 5000;
            heart.timer = scene.time.addEvent({
                delay: heart.duration,
                callback: function() {
                    loose(heart, [heart.list[0]]);
                }
            });
            heartVeins.tween = scene.tweens.add({
                targets: heartVeins,
                scale: 1.2,
                alpha: 1.0,
                duration: heart.duration - 1000
            });

            scene.time.addEvent({
                delay: TIME_BETWEEN_ORGANS,
                callback: function() {
                    activateLung();
                }
            });

            score = scene.add.text(0, 0, 'Time: 00:00', { fontFamily: 'Arial', fontSize: 48, color: '#333333' });
            score.score = 0;
            scoreTimer = scene.time.addEvent({ delay: 1000, callback: function() {
                score.score++;
                var minute = Math.floor(score.score / 60);
                var second = score.score % 60;
                score.text = 'Time: ' + (minute < 10 ? '0' + minute : minute) + ':' + (second < 10 ? '0' + second : second);
            }, callbackScope: this, loop: true });
        }

        // Pump heart

        // Reset loss timer + animation
        heart.timer.elapsed = 0;
        heartVeins.tween.restart();
        if(heartVeins.flash_tween) {
            heartVeins.flash_tween.stop();
        }
        heartVeins.tween.setCallback('onComplete', function() {
            heartVeins.flash_tween = scene.tweens.add({
                targets: heart,
                scale: 1.12,
                duration: 100,
                repeat: 10,
                yoyo: true
            });
        }, [], this);

        // Cancel existing animation
        if(heart.tween) {
            heart.tween.stop();
        }

        // Depending on which state we're in pump in or out
        if(heart.in) {
            heart.in = false;
            heart.tween = scene.tweens.add({
                targets: heart,
                scale: 1.25,
                angle: -5,
                duration: 500,
                ease: 'Bounce.easeOut'
            });
        } else {
            heart.in = true;
            heart.tween = scene.tweens.add({
                targets: heart,
                scale: 1,
                angle: 0,
                duration: 500,
                ease: 'Bounce.easeOut'
            });
        }
    }

    function activateLung() {
        lungPointer.visible = true;
        trachea.alpha = 1.0;
        lung.alpha = 1.0;
        lung.duration = 10000;

        lungArrow.visible = true;
        lungArrow.setInteractive({ pixelPerfect: true, useHandCursor: true });
        lungArrow.on('pointerdown', handleLung);

        handleLung();
        lungPointer.hideNext = true;

        scene.time.addEvent({
            delay: TIME_BETWEEN_ORGANS,
            callback: function() {
                activateLiver();
            }
        });
    }

    function handleLung() {
        if(lungPointer.hideNext) {
            lungPointer.visible = false;
        }

        var breatheIn = lungArrow.texture.key == 'arrow_down';
        lungArrow.setTexture(breatheIn ? 'arrow_up' : 'arrow_down');

        var newDuration = lung.duration;
        if(lung.tween != null) {
            lung.tween.stop();
            newDuration = lung.tween.elapsed;
        }
        if(lung.flash_tween) {
            lung.flash_tween.stop();
            lung.flash_tween = null;
            newDuration = lung.duration;
        }

        var onComplete = function() {
            lung.flash_tween = scene.tweens.add({
                targets: lung,
                scale: 1,
                duration: 100,
                repeat: 10,
                yoyo: true,
                onComplete: function() {
                    loose(lung, [lung.list[0], lung.list[1]]);
                }
            });
        }

        // Depending on which state we're in breathe in or out
        if(breatheIn) {
            lung.tween = scene.tweens.add({
                targets: lung,
                scale: 1.15,
                duration: newDuration,
                onComplete: onComplete
            });
        } else {
            lung.tween = scene.tweens.add({
                targets: lung,
                scale: 0.85,
                duration: newDuration,
                onComplete: onComplete
            });
        }
    }

    function activateLiver() {
        liver.alpha = 1.0;
        liver.duration = 15000;
        scene.tweens.add({
            targets: liver,
            scaleX: 0.95,
            angle: -1,
            duration: 1000,
            repeat: 10000,
            yoyo: true
        });
        liver.add(scene.add.image(-40, -20, 'type'));
        liver.index = -1;

        handleLiver();

        scene.time.addEvent({
            delay: TIME_BETWEEN_ORGANS,
            callback: function() {
                activateKidneys();
            }
        });
    }

    var liverWords = [
        'detoxify', 'metabolize', 'synthesize', 'glycogen', 'hormones', 'bile',
        ''
    ];

    function handleLiver() {
        var newIndex = 0;
        do {
            newIndex = Math.floor(Math.random() * liverWords.length);
        } while(newIndex == liver.index);
        liver.index = newIndex;
        liver.word = liverWords[newIndex];
        liver.wordPosition = 0;
        if(liver.textA) {
            liver.textA.destroy();
            liver.textB.destroy();
        }

        liver.textA = scene.add.text(-112, -15, liver.word, { fontFamily: 'Arial', fontSize: 28, color: '#333333' });
        liver.textA.setOrigin(0, 0.5);
        liver.textB = scene.add.text(-112, -15, '', { fontFamily: 'Arial', fontSize: 28, color: '#008800' });
        liver.textB.setOrigin(0, 0.5);
        liver.add(liver.textA);
        liver.add(liver.textB);

        if(liver.timer) {
            liver.timer.remove();
        }
        liver.timer = scene.time.addEvent({
            delay: liver.duration,
            callback: function() {
                liver.flash_tween = scene.tweens.add({
                    targets: liver,
                    scale: 1.1,
                    duration: 100,
                    repeat: 10,
                    yoyo: true,
                    onComplete: function() {
                        loose(liver, [liver.list[0]]);
                    }
                });
            }
        });

        if(liver.flash_tween) {
            liver.flash_tween.stop();
            liver.flash_tween = null;
        }
    }

    function handleLiverInput(letter) {
        if(letter.toLowerCase() == liver.word.charAt(liver.wordPosition)) {
            liver.wordPosition++;
            liver.textA.text = liver.word.substring(liver.wordPosition, liver.word.length);
            liver.textB.text = liver.word.substring(0, liver.wordPosition);
            liver.textA.x = -112 + liver.textB.width;

            if(liver.wordPosition == liver.word.length) {
                handleLiver();
            }
        }
    }

    function activateKidneys() {
        kidneys.alpha = 1.0;
        leftKidney.pointer.visible = true;
        rightKidney.pointer.visible = true;

        var onComplete = function(tween, targets) {
            targets[0].flash_tween = scene.tweens.add({
                targets: targets[0],
                scale: 0.7,
                duration: 100,
                repeat: 10,
                yoyo: true,
                onComplete: function() {
                    leftKidney.tween.stop();
                    rightKidney.tween.stop();
                    loose(kidneys, [leftKidney, rightKidney]);
                }
            });
        };

        leftKidney.duration = 10000;
        leftKidney.tween = scene.tweens.add({
            targets: leftKidney,
            scale: 0.6,
            duration: leftKidney.duration,
            onComplete: onComplete
        });
        rightKidney.tween = scene.tweens.add({
            targets: rightKidney,
            scale: 0.6,
            duration: leftKidney.duration,
            onComplete: onComplete
        });
        scene.tweens.add({
            targets: leftKidney,
            angle: -5,
            duration: 500,
            yoyo: true,
            repeat: 10000
        });
        scene.tweens.add({
            targets: rightKidney,
            angle: 5,
            duration: 500,
            yoyo: true,
            repeat: 10000
        });

        var handleKidney = function() {
            this.pointer.visible = false;
            if(this.flash_tween) {
                this.flash_tween.stop();
                this.flash_tween = null;
            }
            this.tween.seek(Math.max(this.tween.progress - 0.1, 0));
        };

        leftKidney.setInteractive({ pixelPerfect: true, useHandCursor: true });
        rightKidney.setInteractive({ pixelPerfect: true, useHandCursor: true });
        leftKidney.on('pointerdown', handleKidney.bind(leftKidney));
        rightKidney.on('pointerdown', handleKidney.bind(rightKidney));
    }

    function loose(organ, explode) {
        organ.visible = false;
        for(var i = 0; i < explode.length; i++) {
            var pow = scene.add.image(organ.x + explode[i].x, organ.y + explode[i].y, 'pow');
            pow.scale = 0.2;
            scene.tweens.add({
                targets: pow,
                scale: 1.3,
                duration: 500,
                ease: 'Back.easeOut',
                onComplete: function (tween, targets) {
                    targets[0].visible = false;
                }
            });
        }

        lungArrow.input.enabled = false;
        leftKidney.input.enabled = false;
        rightKidney.input.enabled = false;
        scene.input.keyboard.enabled = false;

        gameOver.visible = true;

        scoreTimer.remove();
    }

</script>

</body>
</html>